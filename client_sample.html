<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Client - Join Video Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .connection-setup {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .video-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        video {
            width: 100%;
            height: 250px;
            background: #000;
            border-radius: 10px;
            object-fit: cover;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        input, button, select {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input, select {
            flex: 1;
            min-width: 150px;
            color: #333;
        }
        
        button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }
        
        .status-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .status-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .step-number {
            background: #4CAF50;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .video-container {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ¥ WebRTC Client</h1>
        <p>Connect to existing video chat rooms</p>
    </div>
    
    <div class="instructions">
        <h3>ðŸ“‹ How to Connect</h3>
        <div class="step">
            <div class="step-number">1</div>
            <div>Enter the server URL (default: localhost:4000)</div>
        </div>
        <div class="step">
            <div class="step-number">2</div>
            <div>Click "Connect to Server" to establish signaling connection</div>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <div>Start your camera and allow browser permissions</div>
        </div>
        <div class="step">
            <div class="step-number">4</div>
            <div>Enter room name and join (e.g., "room1", "meeting", etc.)</div>
        </div>
        <div class="step">
            <div class="step-number">5</div>
            <div>You'll connect to anyone else in the same room!</div>
        </div>
    </div>
    
    <div class="connection-setup">
        <h3>ðŸ”— Server Connection</h3>
        <div class="controls">
            <input type="text" id="serverUrl" placeholder="Server URL" value="http://localhost:4000">
            <button id="connectBtn" onclick="connectToServer()">Connect to Server</button>
            <button id="disconnectBtn" onclick="disconnectFromServer()" disabled>Disconnect</button>
        </div>
        
        <h3>ðŸ“± Camera & Room</h3>
        <div class="controls">
            <button id="startCameraBtn" onclick="startCamera()" disabled>Start Camera</button>
            <input type="text" id="roomInput" placeholder="Room name (e.g., room1)" value="room1" disabled>
            <button id="joinBtn" onclick="joinRoom()" disabled>Join Room</button>
            <button id="leaveBtn" onclick="leaveRoom()" disabled>Leave Room</button>
        </div>
    </div>
    
    <div class="video-container">
        <div class="video-section">
            <h3>ðŸ“¹ Your Camera</h3>
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
        
        <div class="video-section">
            <h3>ðŸ‘¥ Remote Peer</h3>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
    </div>
    
    <div class="status-panel">
        <h3>ðŸ“Š Connection Status</h3>
        <div class="status-grid">
            <div class="status-item">
                <strong>Server</strong><br>
                <span id="serverStatus">Disconnected</span>
            </div>
            <div class="status-item">
                <strong>Camera</strong><br>
                <span id="cameraStatus">Stopped</span>
            </div>
            <div class="status-item">
                <strong>Room</strong><br>
                <span id="roomStatus">Not joined</span>
            </div>
            <div class="status-item">
                <strong>Peer</strong><br>
                <span id="peerStatus">Not connected</span>
            </div>
        </div>
    </div>
    
    <div class="log" id="log"></div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Client Application for WebRTC P2P Connection
        
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const serverUrl = document.getElementById('serverUrl');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const roomInput = document.getElementById('roomInput');
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const logDiv = document.getElementById('log');
        
        // Status elements
        const serverStatus = document.getElementById('serverStatus');
        const cameraStatus = document.getElementById('cameraStatus');
        const roomStatus = document.getElementById('roomStatus');
        const peerStatus = document.getElementById('peerStatus');
        
        let socket;
        let localStream;
        let peerConnection;
        let currentRoom = null;
        let isConnectedToServer = false;
        
        // STUN servers for NAT traversal
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        function log(message) {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>${timestamp}: ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(element, status, className = '') {
            element.textContent = status;
            if (className) {
                element.className = className;
            }
        }
        
        // Connect to signaling server
        function connectToServer() {
            const url = serverUrl.value.trim();
            if (!url) {
                alert('Please enter server URL');
                return;
            }
            
            log(`Connecting to server: ${url}`);
            updateStatus(serverStatus, 'Connecting...');
            
            try {
                socket = io(url);
                
                socket.on('connect', () => {
                    log('Connected to signaling server');
                    updateStatus(serverStatus, 'Connected');
                    isConnectedToServer = true;
                    
                    // Update UI
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    startCameraBtn.disabled = false;
                    serverUrl.disabled = true;
                });
                
                socket.on('disconnect', () => {
                    log('Disconnected from signaling server');
                    updateStatus(serverStatus, 'Disconnected');
                    isConnectedToServer = false;
                    
                    // Reset UI
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    startCameraBtn.disabled = true;
                    joinBtn.disabled = true;
                    leaveBtn.disabled = true;
                    roomInput.disabled = true;
                    serverUrl.disabled = false;
                });
                
                socket.on('connect_error', (error) => {
                    log(`Connection error: ${error.message}`);
                    updateStatus(serverStatus, 'Connection failed');
                });
                
                setupSocketListeners();
                
            } catch (error) {
                log(`Error connecting: ${error.message}`);
                updateStatus(serverStatus, 'Error');
            }
        }
        
        // Set up socket event listeners
        function setupSocketListeners() {
            socket.on('room_joined', (data) => {
                log(`Joined room: ${data.room} (${data.users} users)`);
                currentRoom = data.room;
                updateStatus(roomStatus, `${data.room} (${data.users} users)`);
                
                joinBtn.disabled = true;
                leaveBtn.disabled = false;
                roomInput.disabled = true;
            });
            
            socket.on('room_left', () => {
                log('Left room');
                currentRoom = null;
                updateStatus(roomStatus, 'Not joined');
                updateStatus(peerStatus, 'Not connected');
                
                joinBtn.disabled = false;
                leaveBtn.disabled = true;
                roomInput.disabled = false;
                
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                remoteVideo.srcObject = null;
            });
            
            socket.on('user_joined', (data) => {
                log(`User joined: ${data.user_id} (${data.users} total)`);
                updateStatus(roomStatus, `${currentRoom} (${data.users} users)`);
                
                if (localStream) {
                    createOffer();
                }
            });
            
            socket.on('user_left', (data) => {
                log(`User left: ${data.user_id} (${data.users} remaining)`);
                updateStatus(roomStatus, `${currentRoom} (${data.users} users)`);
                updateStatus(peerStatus, 'Not connected');
                
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                remoteVideo.srcObject = null;
            });
            
            socket.on('offer', async (data) => {
                log('Received offer from peer');
                await handleOffer(data);
            });
            
            socket.on('answer', async (data) => {
                log('Received answer from peer');
                await handleAnswer(data);
            });
            
            socket.on('ice_candidate', async (data) => {
                log('Received ICE candidate');
                await handleIceCandidate(data);
            });
        }
        
        // Disconnect from server
        function disconnectFromServer() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            log('Disconnected from server');
        }
        
        // Start camera
        async function startCamera() {
            try {
                log('Starting camera...');
                updateStatus(cameraStatus, 'Starting...');
                
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: true
                });
                
                localVideo.srcObject = localStream;
                updateStatus(cameraStatus, 'Active');
                
                // Enable room controls
                roomInput.disabled = false;
                joinBtn.disabled = false;
                
                log('Camera started successfully');
                
            } catch (error) {
                log(`Camera error: ${error.message}`);
                updateStatus(cameraStatus, 'Error');
            }
        }
        
        // Join room
        function joinRoom() {
            const room = roomInput.value.trim();
            if (!room) {
                alert('Please enter a room name');
                return;
            }
            
            if (!isConnectedToServer) {
                alert('Please connect to server first');
                return;
            }
            
            log(`Joining room: ${room}`);
            socket.emit('join_room', { room: room });
        }
        
        // Leave room
        function leaveRoom() {
            if (currentRoom) {
                log(`Leaving room: ${currentRoom}`);
                socket.emit('leave_room', { room: currentRoom });
            }
        }
        
        // Create peer connection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);
            
            // Add local stream
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // Handle remote stream
            peerConnection.ontrack = (event) => {
                log('Received remote stream');
                remoteVideo.srcObject = event.streams[0];
                updateStatus(peerStatus, 'Connected');
            };
            
            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    log('Sending ICE candidate');
                    socket.emit('ice_candidate', {
                        room: currentRoom,
                        candidate: event.candidate
                    });
                }
            };
            
            // Connection state changes
            peerConnection.onconnectionstatechange = () => {
                log(`Peer connection state: ${peerConnection.connectionState}`);
                updateStatus(peerStatus, peerConnection.connectionState);
            };
        }
        
        // Create offer (caller)
        async function createOffer() {
            createPeerConnection();
            
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                log('Sending offer to peer');
                socket.emit('offer', {
                    room: currentRoom,
                    offer: offer
                });
            } catch (error) {
                log(`Error creating offer: ${error.message}`);
            }
        }
        
        // Handle offer (callee)
        async function handleOffer(data) {
            createPeerConnection();
            
            try {
                await peerConnection.setRemoteDescription(data.offer);
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                log('Sending answer to peer');
                socket.emit('answer', {
                    room: currentRoom,
                    answer: answer
                });
            } catch (error) {
                log(`Error handling offer: ${error.message}`);
            }
        }
        
        // Handle answer (caller)
        async function handleAnswer(data) {
            try {
                await peerConnection.setRemoteDescription(data.answer);
                log('Answer processed successfully');
            } catch (error) {
                log(`Error handling answer: ${error.message}`);
            }
        }
        
        // Handle ICE candidate
        async function handleIceCandidate(data) {
            try {
                if (peerConnection) {
                    await peerConnection.addIceCandidate(data.candidate);
                    log('ICE candidate added');
                }
            } catch (error) {
                log(`Error adding ICE candidate: ${error.message}`);
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (peerConnection) {
                peerConnection.close();
            }
            if (socket) {
                socket.disconnect();
            }
        });
        
        // Initialize
        log('WebRTC Client initialized');
        log('Ready to connect to server');
        
        // Check WebRTC support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            log('WebRTC not supported in this browser');
            alert('WebRTC not supported in this browser');
        }
    </script>
</body>
</html>
